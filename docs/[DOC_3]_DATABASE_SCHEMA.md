
*\[DOC\_3\] EVIDENS Database Schema*

*Version: 1.2*

*Date: June 16, 2025*

*Purpose: This document provides the canonical and complete database schema for the EVIDENS platform. It is the single source of truth for all tables, columns, data types, and relationships. The AI developer must adhere to this specification precisely when creating database migrations.*

*\================================================================================*

*1.0. Guiding Principles & Conventions*

*\================================================================================*

*\*   RULE 1 (Naming Convention): All table names must use PascalCase. All column names must use snake\_case.*

*\*   RULE 2 (Data Integrity): Foreign keys must be defined with explicit ON DELETE actions (CASCADE or SET NULL). Columns containing essential data must have a NOT NULL constraint.*

*\*   RULE 3 (Data Types): Use the most specific and appropriate data type for each column. All timestamps must be TIMESTAMPTZ (with time zone). All semi-structured data must be JSONB.*

*\*   RULE 4 (Authorization): The primary mechanism for data access control is Row Level Security (RLS). The policies are defined in \`\[DOC\_4\]\_ROW\_LEVEL\_SECURITY.md\`. This schema is designed to support those policies.*

*\================================================================================*

*2.0. Entity Relationship Diagram (ERD)*

*\================================================================================*

*erDiagram*

    *Practitioners {*

        *UUID id PK*

        *String full\_name*

        *String role*

        *String subscription\_tier*

    *}*

    *Reviews {*

        *INT id PK*

        *UUID author\_id FK*

        *JSONB structured\_content*

        *TEXT access\_level*

        *INT community\_post\_id FK*

    *}*

    *Tags {*

        *INT id PK*

        *TEXT tag\_name*

        *INT parent\_id FK*

    *}*

    *ReviewTags {*

        *INT id PK*

        *INT review\_id FK*

        *INT tag\_id FK*

    *}*

    *CommunityPosts {*

        *INT id PK*

        *UUID author\_id FK*

    *}*

    *Practitioners ||--o{ Reviews : "authors"*

    *Practitioners ||--o{ CommunityPosts : "creates"*

    *Reviews }o--|| CommunityPosts : "is\_discussed\_in"*

    *Reviews }o--o{ ReviewTags : "has"*

    *Tags }o--o{ ReviewTags : "is\_tagged\_by"*

    *Tags }o--o{ Tags : "parent\_child"*

*\================================================================================*

*3.0. Table Definitions*

*\================================================================================*

*This section details the primary tables.*

*3.1. Practitioners*

*\*   Purpose: Stores all user account information.*

    *\`\`\`sql*

    *CREATE TABLE "Practitioners" (*

      *"id" UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,*

      *"full\_name" TEXT,*

      *"avatar\_url" TEXT,*

      *"role" TEXT NOT NULL DEFAULT 'practitioner',*

      *"subscription\_tier" TEXT NOT NULL DEFAULT 'free',*

      *"contribution\_score" INT NOT NULL DEFAULT 0,*

      *"profession\_flair" TEXT,*

      *"display\_hover\_card" BOOLEAN NOT NULL DEFAULT TRUE,*

      *"created\_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()*

    *);*

    *\`\`\`*

*3.2. Reviews*

*\*   Purpose: Stores the core content.*

    *\`\`\`sql*

    *CREATE TABLE "Reviews" (*

      *"id" SERIAL PRIMARY KEY,*

      *"author\_id" UUID REFERENCES "Practitioners"(id) ON DELETE SET NULL,*

      *"title" TEXT NOT NULL,*

      *"description" TEXT,*

      *"cover\_image\_url" TEXT,*

      *"structured\_content" JSONB NOT NULL,*

      *"status" TEXT NOT NULL DEFAULT 'draft',*

      *"access\_level" TEXT NOT NULL DEFAULT 'public',*

      *"custom\_redirect\_url" TEXT,*

      *"community\_post\_id" INT REFERENCES "CommunityPosts"(id) ON DELETE SET NULL,*

      *"view\_count" INT NOT NULL DEFAULT 0,*

      *"created\_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),*

      *"published\_at" TIMESTAMPTZ*

    *);*

    *\`\`\`*

    *\*   NOTE: The \`structured\_content\` column MUST contain a valid v2.0 page schema as generated by the Visual Composition Engine and defined in \`\[Blueprint\] 08a\_EDITOR\_BLUEPRINT.md\`.*

*3.3. Tags*

*\*   Purpose: Hierarchical tagging system for categorization.*

    *\`\`\`sql*

    *CREATE TABLE "Tags" (*

      *"id" SERIAL PRIMARY KEY,*

      *"tag\_name" TEXT NOT NULL,*

      *"parent\_id" INT REFERENCES "Tags"("id") ON DELETE CASCADE,*

      *"created\_at" TIMESTAMPTZ NOT NULL DEFAULT NOW()*

    *);*

    *\`\`\`*

*3.4. ReviewTags*

*\*   Purpose: Many-to-many relationship between Reviews and Tags.*

    *\`\`\`sql*

    *CREATE TABLE "ReviewTags" (*

      *"id" SERIAL PRIMARY KEY,*

      *"review\_id" INT NOT NULL REFERENCES "Reviews"("id") ON DELETE CASCADE,*

      *"tag\_id" INT NOT NULL REFERENCES "Tags"("id") ON DELETE CASCADE,*

      *"created\_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),*

      *UNIQUE("review\_id", "tag\_id")*

    *);*

    *\`\`\`*

*(The definitions for all other tables like CommunityPosts, Suggestions, etc., would follow here as previously defined.)*

*\================================================================================*

*4.0. Database Views*

*\================================================================================*

*\*   \[NEW\] This section defines pre-joined or aggregated virtual tables for performance optimization.*

*4.1. v\_contribution\_summary*

*\*   Purpose: To provide a pre-aggregated summary of a user's contributions for efficient display on their profile page.*

*\*   RULE: This view MUST be created during the database migration.*

    *\`\`\`sql*

    *CREATE OR REPLACE VIEW "v\_contribution\_summary" AS*

    *SELECT*

      *p.id AS practitioner\_id,*

      *p.contribution\_score,*

      *COUNT(DISTINCT cp.id) AS total\_posts,*

      *(SELECT COUNT(\*) FROM "CommunityPosts" WHERE author\_id \= p.id AND parent\_post\_id IS NOT NULL) AS total\_comments*

    *FROM*

      *"Practitioners" p*

    *LEFT JOIN*

      *"CommunityPosts" cp ON p.id \= cp.author\_id*

    *GROUP BY*

      *p.id;*

    *\`\`\`*

*\================================================================================*

*5.0. Appendix: Full Table List*

*\================================================================================*

*\*   Practitioners*

*\*   Reviews*

*\*   Tags (NEW)*

*\*   ReviewTags (NEW)*

*\*   CommunityPosts*

*\*   CommunityPostVotes*

*\*   Polls*

*\*   PollOptions*

*\*   PollVotes*

*\*   SiteSettings*

*\*   OnboardingQuestions*

*\*   OnboardingAnswers*

*\*   Reports*

*\*   Notifications*

*\*   Suggestions*

*\*   Suggestion\_Votes*
