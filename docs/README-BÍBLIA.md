
# üìñ README-B√çBLIA: Estado Atual do Projeto EVIDENS

**Vers√£o:** 7.0.0 (Reddit-Style Commenting System Implementation Plan)  
**Data:** 20 de Junho de 2025  
**Status:** ‚úÖ Tasks 1-4 Completados, üîÑ Task 5 Em Planejamento - Sistema de Coment√°rios Reddit-Style

## üöÄ RESUMO EXECUTIVO

O projeto EVIDENS √© uma plataforma cient√≠fica de revis√£o de literatura implementada como uma Progressive Web App (PWA) usando React + Vite + Supabase. O sistema oferece uma experi√™ncia completa de consumo de conte√∫do cient√≠fico com funcionalidades de comunidade, curadoria e personaliza√ß√£o.

**ESTADO ATUAL:** ‚úÖ Tasks 1-4 completos (sistema production-ready), üîÑ Task 5 iniciado - Implementa√ß√£o do Sistema de Coment√°rios Reddit-Style

## üìã FUNCIONALIDADES IMPLEMENTADAS

### ‚úÖ SISTEMA DE AUTENTICA√á√ÉO
- **Status:** 100% Implementado
- **Funcionalidades:**
  - Login/Cadastro com valida√ß√£o robusta
  - Autentica√ß√£o via Google OAuth
  - Gerenciamento de sess√£o com Supabase Auth
  - Sistema de roles (practitioner, editor, admin)
  - Prote√ß√£o de rotas com ProtectedRoute

### ‚úÖ M√ìDULO COMUNIDADE
- **Status:** 100% Implementado e Otimizado
- **Funcionalidades:**
  - Feed infinito de discuss√µes com performance otimizada
  - Sistema de vota√ß√£o (upvote/downvote) com feedback em tempo real
  - Sidebar com regras, links √∫teis e discuss√µes em alta
  - Cria√ß√£o de posts com rich text editor (TipTap)
  - Suporte a imagens, v√≠deos e enquetes
  - Sistema de modera√ß√£o para editores/admins
  - Tratamento robusto de erros e estados de loading
  - Suporte offline com cache inteligente
  - Responsive design com adapta√ß√£o mobile-first

### ‚úÖ ACERVO (COLE√á√ÉO DE REVIEWS)
- **Status:** 100% Implementado
- **Funcionalidades:**
  - Grid responsivo em masonry layout
  - Sistema de tags para categoriza√ß√£o
  - Busca em tempo real com debouncing
  - Filtros por categoria e tags
  - Ordena√ß√£o por relev√¢ncia, data e popularidade
  - Performance otimizada com lazy loading

### ‚úÖ SISTEMA DE REVIEWS
- **Status:** 100% Implementado
- **Funcionalidades:**
  - Visualiza√ß√£o de reviews com renderiza√ß√£o de blocos
  - Suporte a diferentes tipos de conte√∫do (texto, imagens, cita√ß√µes)
  - Layout responsivo com design adaptativo
  - Sistema de slugs para URLs amig√°veis
  - Carregamento otimizado de conte√∫do

### ‚úÖ HOMEPAGE E NAVEGA√á√ÉO
- **Status:** 100% Implementado
- **Funcionalidades:**
  - Feed personalizado com recomenda√ß√µes
  - Carrossel de reviews em destaque
  - M√≥dulo de pr√≥xima edi√ß√£o
  - Sistema de sugest√µes da comunidade
  - Shell de aplica√ß√£o com sidebar/bottom tabs responsivos

### ‚úÖ INFRAESTRUTURA E PERFORMANCE
- **Status:** 100% Implementado
- **Funcionalidades:**
  - Progressive Web App (PWA) com service worker
  - Sistema de cache otimizado
  - Rate limiting em Edge Functions
  - Row Level Security (RLS) implementado
  - Pol√≠ticas de seguran√ßa robustas
  - Tratamento de erros centralizado
  - Logging estruturado para debugging

## üöÄ NOVA IMPLEMENTA√á√ÉO: SISTEMA DE COMENT√ÅRIOS REDDIT-STYLE

### **OBJETIVO ESTRAT√âGICO**
Implementar um sistema completo de coment√°rios estilo Reddit dentro da plataforma EVIDENS, mantendo consist√™ncia arquitetural e maximizando reutiliza√ß√£o de c√≥digo atrav√©s de um modelo unificado de conte√∫do.

### **DECIS√ÉO ARQUITETURAL CENTRAL: MODELO UNIFICADO DE CONTE√öDO**

**Princ√≠pio Fundamental:** Utilizar a tabela `CommunityPosts` existente para posts E coment√°rios, aproveitando a coluna `parent_post_id` j√° implementada.

**Defini√ß√µes:**
- **Post:** Row em `CommunityPosts` onde `parent_post_id = NULL`
- **Coment√°rio:** Row em `CommunityPosts` onde `parent_post_id` referencia outro post/coment√°rio

**Benef√≠cios Estrat√©gicos:**
- ‚úÖ **M√°xima Reutiliza√ß√£o:** Voting, modera√ß√£o, RLS aplicam automaticamente
- ‚úÖ **Simplicidade de Schema:** Zero duplica√ß√£o de estruturas
- ‚úÖ **Seguran√ßa Herdada:** Pol√≠ticas RLS existentes protegem coment√°rios
- ‚úÖ **Analytics Unificadas:** Todo conte√∫do em localiza√ß√£o √∫nica

## üèóÔ∏è PLANO DE IMPLEMENTA√á√ÉO: SISTEMA DE COMENT√ÅRIOS

### **MILESTONE 1: EXTENS√ÉO DO SCHEMA DE BANCO (FASE CR√çTICA)**

#### **Task 1.1: Adi√ß√£o do Sistema de Recompensas**
**Objetivo:** Permitir que admins marquem conte√∫do excepcional
**Arquivos:** Nova migration SQL
**Especifica√ß√£o T√©cnica:**
```sql
-- Migration: add_reward_feature.sql
ALTER TABLE public."CommunityPosts"
ADD COLUMN IF NOT EXISTS is_rewarded BOOLEAN NOT NULL DEFAULT FALSE;

COMMENT ON COLUMN public."CommunityPosts".is_rewarded IS 'Admin reward flag for exceptional content';

CREATE INDEX IF NOT EXISTS idx_community_posts_rewarded
ON public."CommunityPosts" (is_rewarded)
WHERE is_rewarded = TRUE;
```

**Crit√©rios de Verifica√ß√£o:**
- [ ] Coluna `is_rewarded` existe com tipo boolean
- [ ] Valor padr√£o √© `false`
- [ ] √çndice otimizado criado para consultas de conte√∫do recompensado

#### **Task 1.2: Fun√ß√£o RPC para Busca de Coment√°rios**
**Objetivo:** Query eficiente de √°rvore completa de coment√°rios
**Arquivos:** Nova migration SQL
**Especifica√ß√£o T√©cnica:**
```sql
-- Migration: create_comment_fetch_rpc.sql
CREATE OR REPLACE FUNCTION get_comments_for_post(p_post_id INT, p_user_id UUID)
RETURNS TABLE (
    id INT,
    content TEXT,
    created_at TIMESTAMPTZ,
    upvotes INT,
    downvotes INT,
    is_rewarded BOOLEAN,
    parent_post_id INT,
    author JSONB,
    user_vote TEXT,
    reply_count BIGINT,
    nesting_level INT
)
-- Implementa√ß√£o usando Recursive CTE para performance
```

**Diretrizes Governantes:** [DAL.1], [SEC.1]
**Crit√©rios de Verifica√ß√£o:**
- [ ] Fun√ß√£o executa em < 200ms para threads de 100+ coment√°rios
- [ ] Retorna dados hier√°rquicos com nesting_level correto
- [ ] Inclui dados de vota√ß√£o do usu√°rio atual

### **MILESTONE 2: BACKEND - EDGE FUNCTIONS E L√ìGICA**

#### **Task 2.1: Atualiza√ß√£o do Edge Function create-community-post**
**Objetivo:** Suportar cria√ß√£o de coment√°rios e notifica√ß√µes
**Arquivos:** `supabase/functions/create-community-post/index.ts`
**Especifica√ß√£o T√©cnica:**
1. Adicionar `parent_post_id?: number` ao interface `CreatePostRequest`
2. Modificar RPC call para incluir par√¢metro `p_parent_id`
3. Implementar l√≥gica de notifica√ß√£o para replies
4. Validar exist√™ncia de post pai antes da cria√ß√£o

**Crit√©rios de Verifica√ß√£o:**
- [ ] Coment√°rios s√£o criados com `parent_post_id` correto
- [ ] Notifica√ß√µes enviadas para autores de posts pai
- [ ] Rate limiting aplicado corretamente
- [ ] Auto-upvote funciona para coment√°rios

#### **Task 2.2: Novo Edge Function reward-content**
**Objetivo:** Permitir que admins recompensem conte√∫do
**Arquivos:** `supabase/functions/reward-content/index.ts`
**Especifica√ß√£o T√©cnica:**
1. Verifica√ß√£o de role admin/editor obrigat√≥ria
2. Valida√ß√£o de input com Zod schema
3. Update seguro da flag `is_rewarded`
4. Rate limiting configurado

**Diretrizes Governantes:** [SEC.2], [SEC.3]
**Crit√©rios de Verifica√ß√£o:**
- [ ] Apenas admins/editores podem executar
- [ ] Input validation previne ataques
- [ ] Logs detalhados para auditoria

#### **Task 2.3: Atualiza√ß√£o do RPC create_post_and_auto_vote**
**Objetivo:** Suportar par√¢metro parent_post_id
**Arquivos:** Nova migration SQL
**Especifica√ß√£o T√©cnica:**
```sql
CREATE OR REPLACE FUNCTION create_post_and_auto_vote(
  p_author_id uuid, 
  p_title text, 
  p_content text, 
  p_category text,
  p_parent_id integer DEFAULT NULL  -- NOVO PAR√ÇMETRO
)
```

### **MILESTONE 3: FRONTEND - DATA HOOKS**

#### **Task 3.1: Hook usePostWithCommentsQuery**
**Objetivo:** Buscar post com thread completa de coment√°rios
**Arquivos:** `packages/hooks/usePostWithCommentsQuery.ts`
**Especifica√ß√£o T√©cnica:**
1. Usar TanStack Query com `queryKey: ['post-with-comments', postId]`
2. Chamar `get-community-post-detail` para post principal
3. Chamar RPC `get_comments_for_post` para coment√°rios
4. Combinar dados em formato otimizado

**Diretrizes Governantes:** [DAL.2], [DAL.3]
**Crit√©rios de Verifica√ß√£o:**
- [ ] Cache eficiente com stale time apropriado
- [ ] Error handling robusto
- [ ] Loading states granulares

#### **Task 3.2: Hook useCreateCommentMutation**
**Objetivo:** Muta√ß√£o para cria√ß√£o de coment√°rios
**Arquivos:** `packages/hooks/useCreateCommentMutation.ts`
**Especifica√ß√£o T√©cnica:**
1. Usar TanStack Query mutation
2. Chamar Edge Function `create-community-post` com `parent_post_id`
3. Invalidar queries relacionadas em `onSuccess`
4. Optimistic updates para UX

#### **Task 3.3: Hook useRewardContentMutation**
**Objetivo:** Muta√ß√£o para recompensar conte√∫do (admin only)
**Arquivos:** `packages/hooks/useRewardContentMutation.ts`
**Especifica√ß√£o T√©cnica:**
1. Verifica√ß√£o de role no frontend (UX only, seguran√ßa no backend)
2. Chamar Edge Function `reward-content`
3. Invalidar cache do conte√∫do recompensado

### **MILESTONE 4: FRONTEND - COMPONENTES UI**

#### **Task 4.1: Componente Comment**
**Objetivo:** UI para exibir coment√°rio individual
**Arquivos:** `src/components/community/Comment.tsx`
**Especifica√ß√£o T√©cnica:**
1. Indenta√ß√£o visual baseada em `nesting_level`
2. Integra√ß√£o com `VoteButtons` existente
3. Badge visual para conte√∫do recompensado
4. Collapse/expand functionality
5. Reply inline editor toggle

**Diretrizes Governantes:** [AD.1], [AD.2]
**Crit√©rios de Verifica√ß√£o:**
- [ ] Responsive em mobile e desktop
- [ ] Indenta√ß√£o m√°xima limitada para legibilidade
- [ ] Acessibilidade WCAG AA

#### **Task 4.2: Componente CommentEditor**
**Objetivo:** Editor reutiliz√°vel para novos coment√°rios
**Arquivos:** `src/components/community/CommentEditor.tsx`
**Especifica√ß√£o T√©cnica:**
1. Reutilizar `TiptapEditor` existente
2. Valida√ß√£o de conte√∫do m√≠nimo
3. Estados de loading durante submiss√£o
4. Auto-focus quando ativado

#### **Task 4.3: Componente CommentThread**
**Objetivo:** Renderiza√ß√£o recursiva de √°rvore de coment√°rios
**Arquivos:** `src/components/community/CommentThread.tsx`
**Especifica√ß√£o T√©cnica:**
1. Construir √°rvore a partir de lista flat
2. Renderiza√ß√£o recursiva com `Comment` component
3. Lazy loading para threads profundas
4. Performance optimizations com React.memo

#### **Task 4.4: Atualiza√ß√£o CommunityPostPage**
**Objetivo:** Integrar sistema de coment√°rios na p√°gina de post
**Arquivos:** `src/pages/CommunityPostPage.tsx`
**Especifica√ß√£o T√©cnica:**
1. Substituir `usePostDetailQuery` por `usePostWithCommentsQuery`
2. Adicionar `CommentEditor` para novos coment√°rios top-level
3. Renderizar `CommentThread` abaixo do post principal
4. Manter Error Boundaries existentes

### **MILESTONE 5: RECURSOS AVAN√áADOS**

#### **Task 5.1: Sistema de Notifica√ß√µes para Coment√°rios**
**Objetivo:** Notificar usu√°rios sobre replies
**Arquivos:** Backend notifications logic
**Especifica√ß√£o T√©cnica:**
1. Trigger autom√°tico em `create-community-post`
2. Link direto para novo coment√°rio
3. Debouncing para m√∫ltiplos replies

#### **Task 5.2: Modera√ß√£o de Coment√°rios**
**Objetivo:** Ferramentas de modera√ß√£o para coment√°rios
**Arquivos:** Extens√£o de componentes de modera√ß√£o existentes
**Especifica√ß√£o T√©cnica:**
1. Reutilizar `PostActionMenu` existente
2. A√ß√µes espec√≠ficas para coment√°rios
3. Bulk moderation tools

#### **Task 5.3: Analytics e M√©tricas**
**Objetivo:** Tracking de engajamento em coment√°rios
**Arquivos:** Extens√£o do sistema de analytics
**Especifica√ß√£o T√©cnica:**
1. M√©tricas de profundidade de thread
2. Taxa de resposta por usu√°rio
3. Conte√∫do mais comentado

### **MILESTONE 6: OTIMIZA√á√ïES E POLISH**

#### **Task 6.1: Performance Optimizations**
**Objetivo:** Garantir performance em threads grandes
**Implementa√ß√µes:**
1. Virtualization para threads de 1000+ coment√°rios
2. Pagination inteligente
3. Preloading de coment√°rios vizinhos

#### **Task 6.2: Acessibilidade**
**Objetivo:** WCAG AA compliance
**Implementa√ß√µes:**
1. Navega√ß√£o por teclado
2. Screen reader optimization
3. Focus management

#### **Task 6.3: Mobile Adaptations**
**Objetivo:** UX otimizada para mobile
**Implementa√ß√µes:**
1. Swipe gestures para a√ß√µes
2. Compact view para threads profundas
3. Touch-friendly interactive elements

## üîß ARQUITETURA FINAL (P√ìS-COMENT√ÅRIOS)

### **Fluxo de Dados para Coment√°rios**
```mermaid
graph TD
    subgraph "Frontend"
        CP[CommunityPostPage] --> PWCQ[usePostWithCommentsQuery];
        CE[CommentEditor] --> CCM[useCreateCommentMutation];
        CT[CommentThread] --> C[Comment Components];
    end

    subgraph "Backend"
        PWCQ --> GPD[get-post-detail];
        PWCQ --> GCF[get_comments_for_post RPC];
        CCM --> CCP[create-community-post Edge Function];
    end

    subgraph "Database"
        GPD --> CPT[CommunityPosts Table];
        GCF --> CPT;
        CCP --> CPT;
        CCP --> CPV[CommunityPost_Votes];
        CCP --> N[Notifications];
    end
```

### **Estrutura de Componentes**
```
src/components/community/
‚îú‚îÄ‚îÄ Comment.tsx                    # üÜï Coment√°rio individual
‚îú‚îÄ‚îÄ CommentEditor.tsx              # üÜï Editor de coment√°rios
‚îú‚îÄ‚îÄ CommentThread.tsx              # üÜï Thread recursiva
‚îú‚îÄ‚îÄ PostDetailCard.tsx             # ‚úÖ Existente (inalterado)
‚îú‚îÄ‚îÄ VoteButtons.tsx                # ‚úÖ Existente (reutilizado)
‚îî‚îÄ‚îÄ PostActionMenu.tsx             # ‚úÖ Existente (estendido)
```

### **Hooks de Dados**
```
packages/hooks/
‚îú‚îÄ‚îÄ usePostWithCommentsQuery.ts    # üÜï Post + coment√°rios
‚îú‚îÄ‚îÄ useCreateCommentMutation.ts    # üÜï Criar coment√°rio
‚îú‚îÄ‚îÄ useRewardContentMutation.ts    # üÜï Recompensar conte√∫do
‚îú‚îÄ‚îÄ useCastVoteMutation.ts         # ‚úÖ Existente (coment√°rios compat√≠vel)
‚îî‚îÄ‚îÄ usePostDetailQuery.ts          # ‚úÖ Existente (mantido para compatibilidade)
```

## üìä M√âTRICAS DE QUALIDADE ESPERADAS

### **Performance Targets**
- ‚úÖ **Thread Loading:** < 300ms para threads de 50 coment√°rios
- ‚úÖ **Comment Submission:** < 500ms end-to-end
- ‚úÖ **Infinite Scroll:** < 100ms para pr√≥ximo batch
- ‚úÖ **Nesting Depth:** Suporte a 10 n√≠veis com performance

### **UX Metrics**
- ‚úÖ **Reply Rate:** Target > 15% de posts com replies
- ‚úÖ **Thread Depth:** Average 2.5 n√≠veis de profundidade
- ‚úÖ **Mobile Usage:** 70% do traffic via mobile
- ‚úÖ **Accessibility:** WCAG AA compliance

### **Technical Metrics**
- ‚úÖ **Code Reuse:** 80% de funcionalidades herdadas de posts
- ‚úÖ **Test Coverage:** > 90% para componentes cr√≠ticos
- ‚úÖ **Bundle Size:** < 50kb adicional para commenting system
- ‚úÖ **Database Efficiency:** Queries em < 50ms (95th percentile)

## üö® RISCOS IDENTIFICADOS E MITIGA√á√ïES

### **‚úÖ Risco 1: Performance em Threads Profundas - PLANEJADO**
- **Natureza:** Threads com 1000+ coment√°rios podem degradar performance
- **Mitiga√ß√£o:** Virtualization, lazy loading, pagination inteligente

### **‚úÖ Risco 2: Spam de Coment√°rios - PLANEJADO**
- **Natureza:** Rate limiting pode n√£o ser suficiente para spam sofisticado
- **Mitiga√ß√£o:** Rate limiting escalado, detec√ß√£o de padr√µes, moderation tools

### **‚úÖ Risco 3: Notifica√ß√£o Overload - PLANEJADO**
- **Natureza:** Usu√°rios populares podem receber muitas notifica√ß√µes
- **Mitiga√ß√£o:** Debouncing, digest notifications, user preferences

### **‚úÖ Risco 4: Incompatibilidade com Posts Existentes - MITIGADO**
- **Natureza:** Sistema unificado pode quebrar funcionalidades existentes
- **Mitiga√ß√£o:** Backward compatibility garantida, testes extensivos

## üîÑ CRONOGRAMA DE EXECU√á√ÉO

### **Semana 1: Database & Backend Foundation**
- Dias 1-2: Migrations e RPC functions ‚úÖ Cr√≠tico
- Dias 3-4: Edge Functions atualizados ‚úÖ Cr√≠tico
- Dias 5-7: Testes de backend e rate limiting ‚úÖ Cr√≠tico

### **Semana 2: Data Layer & Hooks**
- Dias 1-3: Data hooks implementation ‚úÖ Cr√≠tico
- Dias 4-5: Cache strategy e invalidation ‚úÖ Cr√≠tico
- Dias 6-7: Error handling e optimistic updates ‚úÖ Cr√≠tico

### **Semana 3: Core UI Components**
- Dias 1-2: Comment component ‚úÖ Cr√≠tico
- Dias 3-4: CommentEditor e CommentThread ‚úÖ Cr√≠tico
- Dias 5-7: Integration com CommunityPostPage ‚úÖ Cr√≠tico

### **Semana 4: Advanced Features & Polish**
- Dias 1-2: Notifications e moderation
- Dias 3-4: Performance optimizations
- Dias 5-7: Accessibility e mobile polish

## üîç DEBUGGING E LOGS (COMENT√ÅRIOS)

### **Logging Strategy**
- Comment creation/editing events
- Vote patterns em coment√°rios
- Performance metrics para threads
- Error tracking para nesting issues

### **Debugging Tools**
- React DevTools para component tree
- TanStack Query DevTools para cache
- Supabase logs para RPC performance
- Custom metrics dashboard

## üìà ROADMAP P√ìS-COMENT√ÅRIOS

### **Recursos Futuros Planejados**
- Sistema de badges para contribuidores
- AI-powered comment summarization
- Real-time collaborative editing
- Advanced search em coment√°rios
- Comment templates para modera√ß√£o

### **Otimiza√ß√µes T√©cnicas Futuras**
- GraphQL migration para queries complexas
- Comment preloading com ML
- Advanced caching strategies
- Micro-frontends para coment√°rios

---

**√öltima Atualiza√ß√£o:** Sistema de Coment√°rios Reddit-Style - Plano arquitetural completo documentado

**Pr√≥xima Revis√£o:** Ap√≥s implementa√ß√£o do Milestone 1 (Database & Backend Foundation)

**Status de Implementa√ß√£o:** 
- ‚úÖ Task 1 (Data Decoupling) - Completo e verificado
- ‚úÖ Task 2 (Error Boundaries) - 100% completo, sistema hier√°rquico implementado
- ‚úÖ Task 3 (Strict TypeScript) - 100% completo, type safety garantida
- ‚úÖ Task 4 (Code Consistency) - 100% completo, tema funcional, build limpo
- üîÑ Task 5 (Reddit-Style Comments) - Plano arquitetural completo, pronto para execu√ß√£o

**Progresso Geral:** 100% do hardening conclu√≠do, novo sistema de coment√°rios planejado

**Pr√≥ximos Passos:** 
1. Executar Milestone 1 (Database Schema Extensions)
2. Implementar Milestone 2 (Backend Functions)
3. Desenvolver Milestone 3 (Data Hooks)
4. Construir Milestone 4 (UI Components)

**Complexidade Estimada:** 4 semanas de desenvolvimento full-time
**Risk Level:** M√©dio (arquitetura bem estabelecida, patterns existentes)
**Success Criteria:** Sistema funcional com performance targets atingidos
